# ASP.NET Core Unified Deployment Pipeline
# Build and deploy ASP.NET Core projects to Azure Linux Web Apps
# Supports both framework-dependent and self-contained deployments
# Supports both production and test environments
#
# The pipeline automatically configures the target app service based on deployment mode:
# - Sets SELF_CONTAINED_DEPLOYMENT environment variable (true/false)
# - Configures startup command (/home/site/wwwroot/m4d for self-contained, empty for framework-dependent)
# - No manual Azure Portal configuration required

pool:
  vmImage: ubuntu-latest

parameters:
  - name: deploymentMode
    displayName: "Deployment Mode"
    type: string
    default: "framework-dependent"
    values:
      - "framework-dependent"
      - "self-contained"

  - name: environment
    displayName: "Target Environment"
    type: string
    default: "test"
    values:
      - "production"
      - "test"
      - "staging"

variables:
  buildConfiguration: "Release"
  ${{ if eq(parameters.environment, 'production') }}:
    appName: "msc4dnc"
    aspnetEnvironment: "Production"
    searchIndex: "SongIndexProd"
    searchIndexVersion: "2"
  ${{ if eq(parameters.environment, 'test') }}:
    appName: "m4d-linux"
    aspnetEnvironment: "Development"
    searchIndex: "SongIndexTest"
    searchIndexVersion: "2"
  ${{ if eq(parameters.environment, 'staging') }}:
    appName: "m4d-staging"
    aspnetEnvironment: "Staging"
    searchIndex: "SongIndexTest"
    searchIndexVersion: "2"
  ${{ if eq(parameters.deploymentMode, 'self-contained') }}:
    useSelfContained: true
  ${{ if eq(parameters.deploymentMode, 'framework-dependent') }}:
    useSelfContained: false

steps:
  # ===== CLIENT BUILD =====
  - task: NodeTool@0
    displayName: "Install Node.js"
    inputs:
      versionSpec: "22.x"

  - script: corepack enable
    displayName: "Enable Corepack"

  - script: yarn config set globalFolder "$(Agent.BuildDirectory)\Yarn\Berry"
    displayName: "Set Yarn global folder"
    workingDirectory: m4d/ClientApp/

  - script: yarn install --network-timeout=300000
    displayName: "Install Yarn dependencies"
    workingDirectory: m4d/ClientApp/

  - script: yarn build
    displayName: "Build Vue.js ClientApp"
    workingDirectory: m4d/ClientApp/

  # ===== SERVER BUILD =====
  - task: UseDotNet@2
    displayName: "Install .NET 10 SDK"
    inputs:
      packageType: "sdk"
      version: "10.x"

  - script: dotnet build --configuration $(buildConfiguration)
    displayName: "Build .NET project ($(buildConfiguration))"

  # ===== PUBLISH (Self-Contained) =====
  - task: DotNetCoreCLI@2
    displayName: "Publish web project (self-contained)"
    condition: eq(variables['useSelfContained'], true)
    inputs:
      command: "publish"
      arguments: "--configuration $(buildConfiguration) --runtime linux-x64 --self-contained true /p:SelfContained=true"
      publishWebProjects: true

  # ===== PUBLISH (Framework-Dependent) =====
  - task: DotNetCoreCLI@2
    displayName: "Publish web project (framework-dependent)"
    condition: eq(variables['useSelfContained'], false)
    inputs:
      command: "publish"
      arguments: "--configuration $(buildConfiguration) --runtime linux-x64"
      publishWebProjects: true

  # ===== DEPLOY =====
  - task: AzureWebApp@1
    displayName: "Deploy to Azure Web App ($(appName))"
    inputs:
      azureSubscription: "m4d-release"
      appType: "webAppLinux"
      appName: "$(appName)"
      package: "$(System.DefaultWorkingDirectory)/**/*.zip"

  # ===== CONFIGURE DEPLOYMENT MODE =====
  - task: AzureCLI@2
    displayName: "Configure app settings for deployment mode"
    continueOnError: true # Don't fail deployment if configuration fails
    inputs:
      azureSubscription: "m4d-release"
      scriptType: "bash"
      scriptLocation: "inlineScript"
      inlineScript: |
        echo "Configuring $(appName) for deployment mode: ${{ parameters.deploymentMode }}"
        echo "Configuring environment: ${{ parameters.environment }} (ASPNETCORE_ENVIRONMENT=$(aspnetEnvironment))"
        echo "Search index configuration: $(searchIndex) version $(searchIndexVersion)"

        # Set application settings
        echo "Setting application settings..."
        if az webapp config appsettings set \
          --name $(appName) \
          --resource-group music4dance \
          --settings \
            SELF_CONTAINED_DEPLOYMENT=$(useSelfContained) \
            ASPNETCORE_ENVIRONMENT=$(aspnetEnvironment) \
            SEARCHINDEX=$(searchIndex) \
            SEARCHINDEXVERSION=$(searchIndexVersion); then
          echo "✓ Application settings configured successfully"
        else
          echo "✗ Failed to set application settings (insufficient permissions)"
          echo "  Please set manually in Azure Portal or grant 'Website Contributor' role to service principal"
        fi

        # Configure startup command based on deployment mode
        if [ "$(useSelfContained)" = "true" ]; then
          echo "Setting startup command for self-contained deployment: /home/site/wwwroot/m4d"
          if az webapp config set \
            --name $(appName) \
            --resource-group music4dance \
            --startup-file "/home/site/wwwroot/m4d"; then
            echo "✓ Startup command set successfully"
          else
            echo "✗ Failed to set startup command (insufficient permissions)"
            echo "  Please set manually in Azure Portal: /home/site/wwwroot/m4d"
          fi
        else
          echo "Setting startup command for framework-dependent deployment: dotnet m4d.dll"
          if az webapp config set \
            --name $(appName) \
            --resource-group music4dance \
            --startup-file "dotnet m4d.dll"; then
            echo "✓ Startup command set successfully"
          else
            echo "✗ Failed to set startup command (insufficient permissions)"
            echo "  Please set manually in Azure Portal: dotnet m4d.dll"
          fi
        fi

        echo "Configuration step complete (check above for any failures)"
