# ASP.NET Core Unified Deployment Pipeline
# Build and deploy ASP.NET Core projects to Azure Linux Web Apps
# Supports both framework-dependent and self-contained deployments
# Supports both production and test environments
#
# The pipeline automatically configures the target app service based on deployment mode:
# - Sets SELF_CONTAINED_DEPLOYMENT environment variable (true/false)
# - Configures startup command (/home/site/wwwroot/m4d for self-contained, empty for framework-dependent)
# - No manual Azure Portal configuration required

pool:
  vmImage: ubuntu-latest

parameters:
  - name: deploymentMode
    displayName: "Deployment Mode"
    type: string
    default: "framework-dependent"
    values:
      - "framework-dependent"
      - "self-contained"

  - name: environment
    displayName: "Target Environment"
    type: string
    default: "test"
    values:
      - "production"
      - "test"
      - "staging"

variables:
  buildConfiguration: "Release"
  ${{ if eq(parameters.environment, 'production') }}:
    appName: "msc4dnc"
    aspnetEnvironment: "Production"
    searchIndex: "SongIndexProd"
    searchIndexVersion: "2"
  ${{ if eq(parameters.environment, 'test') }}:
    appName: "m4d-linux"
    aspnetEnvironment: "Development"
    searchIndex: "SongIndexTest"
    searchIndexVersion: "2"
  ${{ if eq(parameters.environment, 'staging') }}:
    appName: "m4d-staging"
    aspnetEnvironment: "Staging"
    searchIndex: "SongIndexTest"
    searchIndexVersion: "2"
  ${{ if eq(parameters.deploymentMode, 'self-contained') }}:
    useSelfContained: true
  ${{ if eq(parameters.deploymentMode, 'framework-dependent') }}:
    useSelfContained: false

steps:
  # ===== CLIENT BUILD =====
  - task: NodeTool@0
    displayName: "Install Node.js"
    inputs:
      versionSpec: "22.x"

  - script: corepack enable
    displayName: "Enable Corepack"

  - script: yarn config set globalFolder "$(Agent.BuildDirectory)\Yarn\Berry"
    displayName: "Set Yarn global folder"
    workingDirectory: m4d/ClientApp/

  - script: yarn install --network-timeout=300000
    displayName: "Install Yarn dependencies"
    workingDirectory: m4d/ClientApp/

  - script: yarn build
    displayName: "Build Vue.js ClientApp"
    workingDirectory: m4d/ClientApp/

  # ===== SERVER BUILD =====
  - task: UseDotNet@2
    displayName: "Install .NET 10 SDK"
    inputs:
      packageType: "sdk"
      version: "10.x"

  - script: dotnet build --configuration $(buildConfiguration)
    displayName: "Build .NET project ($(buildConfiguration))"

  # ===== PUBLISH (Self-Contained) =====
  - task: DotNetCoreCLI@2
    displayName: "Publish web project (self-contained)"
    condition: eq(variables['useSelfContained'], true)
    inputs:
      command: "publish"
      arguments: "--configuration $(buildConfiguration) --runtime linux-x64 --self-contained true /p:SelfContained=true"
      publishWebProjects: true

  # ===== PUBLISH (Framework-Dependent) =====
  - task: DotNetCoreCLI@2
    displayName: "Publish web project (framework-dependent)"
    condition: eq(variables['useSelfContained'], false)
    inputs:
      command: "publish"
      arguments: "--configuration $(buildConfiguration) --runtime linux-x64"
      publishWebProjects: true

  # ===== DEPLOY WITH CONFIGURATION =====
  # Deploy and configure app settings in a single atomic operation
  # This approach uses the AzureWebApp task's built-in appSettings parameter
  # which avoids permission issues and ensures settings are applied during deployment

  # Self-Contained Deployment
  - task: AzureWebApp@1
    displayName: "Deploy to Azure Web App ($(appName)) - self-contained"
    condition: eq(variables['useSelfContained'], true)
    inputs:
      azureSubscription: "m4d-release"
      appType: "webAppLinux"
      appName: "$(appName)"
      package: "$(System.DefaultWorkingDirectory)/**/*.zip"
      startUpCommand: "/home/site/wwwroot/m4d"
      appSettings: |
        -SELF_CONTAINED_DEPLOYMENT true
        -ASPNETCORE_ENVIRONMENT $(aspnetEnvironment)
        -SEARCHINDEX $(searchIndex)
        -SEARCHINDEXVERSION $(searchIndexVersion)
        -WEBSITES_INCLUDE_CLOUD_CERTS true

  # Framework-Dependent Deployment
  - task: AzureWebApp@1
    displayName: "Deploy to Azure Web App ($(appName)) - framework-dependent"
    condition: eq(variables['useSelfContained'], false)
    inputs:
      azureSubscription: "m4d-release"
      appType: "webAppLinux"
      appName: "$(appName)"
      package: "$(System.DefaultWorkingDirectory)/**/*.zip"
      startUpCommand: "dotnet m4d.dll"
      appSettings: |
        -SELF_CONTAINED_DEPLOYMENT false
        -ASPNETCORE_ENVIRONMENT $(aspnetEnvironment)
        -SEARCHINDEX $(searchIndex)
        -SEARCHINDEXVERSION $(searchIndexVersion)
        -WEBSITES_INCLUDE_CLOUD_CERTS true
