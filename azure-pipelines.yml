# ASP.NET Core Unified Deployment Pipeline
# Build and deploy ASP.NET Core projects to Azure Linux Web Apps
# Supports both framework-dependent and self-contained deployments
# Supports both production and test environments

pool:
  vmImage: ubuntu-latest

parameters:
  - name: deploymentMode
    displayName: "Deployment Mode"
    type: string
    default: "framework-dependent"
    values:
      - "framework-dependent"
      - "self-contained"

  - name: environment
    displayName: "Target Environment"
    type: string
    default: "test"
    values:
      - "production"
      - "test"

variables:
  buildConfiguration: "Release"
  ${{ if eq(parameters.environment, 'production') }}:
    appName: "msc4dnc"
  ${{ if eq(parameters.environment, 'test') }}:
    appName: "m4d-linux"
  ${{ if eq(parameters.deploymentMode, 'self-contained') }}:
    useSelfContained: true
  ${{ if eq(parameters.deploymentMode, 'framework-dependent') }}:
    useSelfContained: false

steps:
  # ===== CLIENT BUILD =====
  - task: NodeTool@0
    displayName: "Install Node.js"
    inputs:
      versionSpec: "22.x"

  - script: corepack enable
    displayName: "Enable Corepack"

  - script: yarn config set globalFolder "$(Agent.BuildDirectory)\Yarn\Berry"
    displayName: "Set Yarn global folder"
    workingDirectory: m4d/ClientApp/

  - script: yarn install --network-timeout=300000
    displayName: "Install Yarn dependencies"
    workingDirectory: m4d/ClientApp/

  - script: yarn build
    displayName: "Build Vue.js ClientApp"
    workingDirectory: m4d/ClientApp/

  # ===== SERVER BUILD =====
  - task: UseDotNet@2
    displayName: "Install .NET 9 SDK"
    inputs:
      packageType: "sdk"
      version: "9.x"

  - script: dotnet build --configuration $(buildConfiguration)
    displayName: "Build .NET project ($(buildConfiguration))"

  # ===== PUBLISH (Self-Contained) =====
  - task: DotNetCoreCLI@2
    displayName: "Publish web project (self-contained)"
    condition: eq(variables['useSelfContained'], true)
    inputs:
      command: "publish"
      arguments: "--configuration $(buildConfiguration) --runtime linux-x64 --self-contained true /p:SelfContained=true"
      publishWebProjects: true

  # ===== PUBLISH (Framework-Dependent) =====
  - task: DotNetCoreCLI@2
    displayName: "Publish web project (framework-dependent)"
    condition: eq(variables['useSelfContained'], false)
    inputs:
      command: "publish"
      arguments: "--configuration $(buildConfiguration) --runtime linux-x64"
      publishWebProjects: true

  # ===== DEPLOY =====
  - task: AzureWebApp@1
    displayName: "Deploy to Azure Web App ($(appName))"
    inputs:
      azureSubscription: "m4d-release"
      appType: "webAppLinux"
      appName: "$(appName)"
      package: "$(System.DefaultWorkingDirectory)/**/*.zip"
