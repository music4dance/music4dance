@using m4d.Utilities
@model Song

@Html.Partial("SetupSongScript")

@{
    SongFilter filter = ViewData.ContainsKey("SongFilter") ? ViewBag.SongFilter : new SongFilter();
}

@helper Actions(SongFilter filter)
{
    <a class="btn btn-ml btn-help" href="https://www.music4dance.net/blog/music4dance-help/playing-or-purchasing-songs/" role="button"><span class="glyphicon glyphicon-question-sign"></span></a>
    @Html.ActionLink("Back to List", filter.TargetAction, new { filter }, new { @class = "btn btn-ml btn-primary", role = "button" })
    <a href="#" role="button" class="btn btn-ml btn-primary" data-bind="visible:changed, click:saveRatings">Save</a>
}

@helper EchoValue(string type, float? value)
{
    if (!value.HasValue)
    {
        return;
    }
    var dec = (int)Math.Floor(value.Value * 10) + 1;
    var img = "/content/" + @type + "-" + dec + ".png";
    <img src="@img" width="35" height="35"/>
    <span>@type = @value.Value.ToString("F3")</span>
}


<div class="page-header">
    <h1>
        @if (User.Identity.IsAuthenticated)
        {
            <a class="btn btn-sm btn-info" role="button" data-show="tooltip" data-placement="right" data-bind="attr: {'data-original-title':song.liketip},click:toggleVote">
                <img data-bind="attr: {src:song.voteImage}" />
            </a>
        }
        @Model.Title
        @if (!string.IsNullOrWhiteSpace(@Model.Artist))
        {
            <small>by @Html.ActionLink(Model.Artist, "artist", "song", new { name = Model.Artist }, null)</small>
        }
    </h1>
</div>
@{
    var region = User.Region();
    if (string.IsNullOrWhiteSpace(region))
    {
        region = "US";
    }
}
@Html.Partial("ItemTags")

<div class="row">
    <div class="col-md-12">
        <span class="hidden-xs">
            @{
                ViewBag.UseLogo = false;
                @Html.Partial("_PurchaseLinks", Model.GetPurchaseLinks("AISX",region))
            }
        </span>
        <span class="visible-xs">
            @{
                ViewBag.UseLogo = true;
                @Html.Partial("_PurchaseLinks", Model.GetPurchaseLinks("AISX", region))
            }
        </span>
        @Actions(filter)
    </div>
</div>

<div class="row">
    <fieldset>
        <div class="col-sm-3">
            @if (Model.Length != null)
            {
                <div class="display-label">
                    @Html.DisplayNameFor(model => model.Length):
                </div>
                <div class="display-field">
                    @Html.DisplayFor(model => model.Length, "SongDuration")
                </div>
                <br />
            }
        </div>
        <div class="col-sm-3">
            @if (Model.Tempo != null)
            {
                <div class="display-label">
                    @Html.DisplayNameFor(model => model.Tempo):
                </div>
                <div class="display-field">
                    @decimal.Round(Model.Tempo.Value).ToString("F0") BPM
                </div>
                <br />
            }
        </div>
    </fieldset>
</div>

@if (Model.TagSummary.Tags.Count != 0 || User.Identity.IsAuthenticated)
{
    <div class="row">
        <div class="col-md-12">
            <h4>
                <span data-bind="template: {name:'tag-template',foreach:song.TagSummary.tagGroups}"></span>
            </h4>
        </div>
    </div>
}

@if (Model.Danceability.HasValue)
{
    <div class="row">
        <div class="col-md-12">
            @EchoHelper.EchoValues(Model, 35, true)
        </div>
    </div>
}

@if (Model.DanceRatings != null)
{
    <div class="row" style="padding-top: 5px">
        @Html.Partial("Dances")
    </div>
}

@if (Model.Sample != null && Model.Sample != ".")
{
    <div class="row" style="padding-bottom: 10px">
        <h2 class="col-sm-2">Preview:</h2>
        <audio controls class="col-sm-8">
            <source src="@Model.Sample" type="audio/mpeg" />
            Your browser does not support audio.
        </audio>
    </div>
}

@if (Model.HasAlbums)
{
    <div class="row">
        <div class="col-md-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Albums</h3>
                </div>
                <ul class="panel-body list-group">
                    @foreach (var album in Model.Albums)
                    {
                        <li class="list-group-item">@Html.Partial("AlbumDetails", album)</li>
                    }
                </ul>
            </div>
        </div>
    </div>
}

<div class="row">
    <fieldset>
        <div class="col-sm-3">
            <div class="display-label">
                @Html.DisplayNameFor(model => model.Created):
            </div>
            <div class="display-field">
                @Html.DisplayFor(model => model.Created)
            </div>
            <br />
        </div>
        <div class="col-sm-3">
            <div class="display-label">
                @Html.DisplayNameFor(model => model.Modified):
            </div>
            <div class="display-field">
                @Html.DisplayFor(model => model.Modified)
            </div>
        </div>
        @if (Model.Tempo.HasValue)
        {
            <div class="col-sm-3">
                <a href="http://the.echonest.com"><img src="~/Content/echonest.png" alt="EchoNest" title="Some information on this page provided by EchoNest" /></a>
            </div>
        }
    </fieldset>
</div>

@Html.Partial("_TagEditor")

