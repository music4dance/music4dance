@using System.Linq
@using System.Net
@using DanceLibrary
@using m4dModels
@using m4d.ViewModels
@using Microsoft.AspNetCore.Html
@using Newtonsoft.Json
@model IEnumerable<Song>

@{
    var isAdmin = User.IsInRole("dbAdmin");
    var action = "index";

    var canSort = ViewData.ContainsKey("NoSort") ? !ViewBag.NoSort : true;
    var showDate = canSort || (ViewData.ContainsKey("ShowDate") ? ViewBag.ShowDate : false);
    var hideDances = ViewData.ContainsKey("HideDances") ? ViewBag.HideDances : false;
    string albumName = ViewData.ContainsKey("AlbumName") ? ViewBag.AlbumName : null;
    var hideArtist = ViewData.ContainsKey("HideArtist") ? ViewBag.HideArtist : false;
    var showLength = ViewData.ContainsKey("ShowLength") ? ViewBag.ShowLength : false;

    DanceStatsInstance danceStats = ViewBag.DanceStats;
    SongFilter filter = ViewData.ContainsKey("SongFilter") ? ViewBag.SongFilter : new SongFilter(action);
    var isRaw = filter.IsRaw;
    canSort = canSort && !isRaw;
    var songOrder = new SongSort(filter.SortOrder);
    var danceId = ViewData.ContainsKey("DanceId") ? ViewBag.DanceId : null;
    var danceName = (isRaw || danceId == null) ? null : danceStats.FromId(danceId).DanceName;
    var azureSearch = filter.IsAzure;
    LikeDictionary likes = ViewData.ContainsKey("Likes") ? ViewBag.Likes : null;
    LikeDictionary danceLikes = ViewData.ContainsKey("DanceLikes") ? ViewBag.DanceLikes : null;

    var filterNoDance = new SongFilter(filter.ToString())
    {
        Dances = null,
        SortOrder = null
    };
    var danceQuery = filter.DanceQuery;
    var numDances = danceQuery.Dances.Count();
    var isExclusive = danceQuery.IsExclusive || numDances < 2;
    var isInclusive = (!danceQuery.IsExclusive || numDances == 1) && (filterNoDance.IsEmptyPaged || numDances > 1);

    const string likeTipNull = "Click to like/dislike {0}.";
    const string likeTipTrue = "You have liked {0}, click to dislike";
    const string likeTipFalse = "You have disliked {0}, click to reset";

    Func<dynamic, IHtmlContent> artistHeader = 
        @<text>
            @if (canSort)
            {
                @Html.ActionLink("Artist", "Sort", "Song", new { sortOrder = "Artist", filter }, null)
                @Html.Raw(songOrder.GetSortGlyph("Artist"))
            }
            else
            {
                <text> Artist </text>
            }
         </text>;

    Func<Song, IHtmlContent> artist = 
        @<text>
            @if (!string.IsNullOrWhiteSpace(item.Artist))
            {
                @Html.ActionLink(item.Artist, "artist", "song", new { name = item.Artist }, null)
            }
         </text>;

    Func<dynamic, IHtmlContent> tagHeader =
        @<text>
            <text>Tags</text>
            @if (!string.IsNullOrWhiteSpace(filter.Tags))
            {
                var tags = new TagList(filter.Tags);
                var inc = tags.ExtractAdd();
                var exc = tags.ExtractRemove();
                if (!inc.IsEmpty)
                {
                    <br /><span> Included:</span>
                    foreach (var tag in inc.Tags)
                    {
                        if (!tag.Contains(':')) { continue; }

                        var rg = tag.Split(':');
                        var url = "/song/removetags?tags=" + WebUtility.UrlEncode(tag) + "&filter=" + WebUtility.UrlEncode(filter.ToString());
                        var img = "/images/icons/" + TagGroup.ClassToName(rg.Length > 0 ? rg[1] : "tag") + "-50.png";
                        <span class="label label-@rg[1].ToLower()" style="margin-right: 5px"><a role="button" class="tag-text" href="@url"><img src="@img" height="12" width="12" />@rg[0] <span class="glyphicon glyphicon-remove-sign"></span></a></span>
                    }
                }
                if (!exc.IsEmpty)
                {
                    <br /><span>Excluded:</span>
                    foreach (var tag in exc.Tags)
                    {
                        var rg = tag.Split(':');
                        var url = "/song/removetags?tags=" + WebUtility.UrlEncode(tag) + "&filter=" + WebUtility.UrlEncode(filter.ToString());
                        <span class="label label-@rg[1].ToLower()" style="margin-right: 5px"><a role="button" class="tag-text" href="@url">@rg[0] <span class="glyphicon glyphicon-remove-sign"></span></a></span>
                    }
                }
            }
         </text>;

    Func<Song, IHtmlContent> tagList =
        @<text>
            @foreach (var tagItem in item.TagSummary.Tags.Where(t => !string.Equals(t.TagClass, "dance", StringComparison.OrdinalIgnoreCase)))
            {
                <partial name="_TagModalButton" model="@new TagModalModel { Tag = tagItem, Filter = filter, Song = item }"/>
            }
         </text>;

    Func<Song, IHtmlContent> time = 
        @<text>
            @{
                var created = songOrder.Id == "Created";
                var prefix = created ? "Created" : "Last modified";
                var time = created ? item.Created : item.Modified;
                var delta = created ? item.CreatedOrderVerbose : item.ModifiedOrderVerbose;
                var timeMessage = prefix + " on " + time.ToString("g") + " (" + delta + " ago)";
            }

            <td class="hidden-xs" data-toggle="tooltip" data-placement="left" title="@timeMessage">
                @(created? item.CreatedOrder : item.ModifiedOrder)
            </td>

         </text>;
}


<script>
    window.VoteOptions = {
        'true': { tip: '@likeTipTrue', img: '' },
        'false': { tip: '@likeTipFalse', img: '-broken' },
        'null': { tip: '@likeTipNull', img: '-outline' }
    };
</script>

<table class="table table-striped table-songs">
    <thead>
    <tr>
        <th style="width:@(danceId==null?"75":"120")px">Like/Play</th>

        @if (isAdmin)
        {
            <th>&nbsp;</th>
            if (canSort)
            {
                <th>&nbsp;</th>
            }
        }
        <th style="min-width:75px" data-toggle="tooltip" data-placement="bottom" data-container="body" title="@("Song Title" + (canSort ? ": Click to sort alphabetically by Title" : string.Empty))">
            @if (canSort)
            {
                @Html.ActionLink("Title", "Sort", "Song", new {sortOrder = "Title", filter}, null)
                @Html.Raw(songOrder.GetSortGlyph("Title"))
            }
            else
            {
                <text>Title</text>
            }
            @if (!hideArtist)
            {
                <span class="visible-xs"> - @artistHeader(null)</span>
            }
        </th>
        @if (!hideArtist)
        {
            <th class="hidden-xs" style="min-width:75px" data-toggle="tooltip" data-placement="bottom" data-container="body" title="@("Artist" + (canSort ? ": Click to sort alphabetically by Artist" : string.Empty))">
                @artistHeader(null)
            </th>
        }
        @if (albumName == null)
        {
                @* TODO: Reinstate album name when we get user selectable columns
                    <th style="min-width:75pt" class="hidden-xs">
                    @if (canSort)
                    {
                        @Html.ActionLink("Album", "Sort", "Song", new { sortOrder = "Album", filter }, null)
                        @Html.Raw(songOrder.GetSortGlyph("Album"))
                    }
                    else
                    {
                        <text>Album</text>
                    }
                </th>*@
        }
        else
        {
            <th style="min-width:75px" class="hidden-xs">
                Track
            </th>
        }
        <th class="hidden-xs" data-toggle="tooltip" data-placement="bottom" data-container="body" title="@("Tempo (in Beats Per Minute)" + (canSort ? ": Click to sort numerically by tempo" : string.Empty))">
            @if (canSort)
            {
                @Html.ActionLink("Tempo (BPM)", "sort", "song", new {sortOrder = "Tempo", filter}, null)
                @Html.Raw(songOrder.GetSortGlyph("Tempo"))
            }
            else
            {
                <text>Tempo (BPM)</text>
            }
        </th>
        @if (showLength)
        {
            <th class="hidden-xs">
                Length
            </th>
        }

        <th style="min-width: 100px" class="hidden-xs">
            @{
                var beatModel = new EchoHeaderModel { Type = "Beat", CanSort = canSort, SongOrder = filter.SongSort, Filter = filter };
                var energyModel = new EchoHeaderModel { Type = "Energy", CanSort = canSort, SongOrder = filter.SongSort, Filter = filter };
                var moodModel = new EchoHeaderModel { Type = "Mood", CanSort = canSort, SongOrder = filter.SongSort, Filter = filter };
            }
            <partial name="_EchoHeader" model="@beatModel" />
            <partial name="_EchoHeader" model="@energyModel" />
            <partial name="_EchoHeader" model="@moodModel"/>
        </th>

        @if (!hideDances)
        {
            <th style="max-width:200px" data-toggle="tooltip" data-placement="bottom" data-container="body" title="@("Dance Style Tags" + (canSort ? ": Click to sort by most voted on dance style." : string.Empty))">
                @if (canSort && !azureSearch)
                {
                    @Html.ActionLink("Dances", "sort", "song", new {sortOrder = "Dances", filter}, null)
                    @Html.Raw(songOrder.GetSortGlyph("Dances"))
                }
                else
                {
                    <text>Dances</text>
                }
                <span class="visible-xs"> -@tagHeader(null)</span>
            </th>
        }
        <th style="max-width:200px" class="@(hideDances ? string.Empty : "hidden-xs")">@tagHeader(null)</th>
        @if (isAdmin)
        {
            <th></th>
        }
        @if (showDate)
        {
            var created = (songOrder.Id == "Created");
            var dateId = created ? "Created" : "Modified";
            <th class="hidden-xs" style="min-width: 50px" data-toggle="tooltip" data-placement="bottom" data-container="body" title="@(dateId + (canSort ? ": Click to sort by date " + dateId : string.Empty))">
                @if (canSort)
                {
                    <a href="@Url.Action("sort", "song", new {sortOrder = dateId, filter})"><span class='glyphicon @(created ? "glyphicon-plus" : "glyphicon-pencil")'></span></a>
                }
                else
                {
                    <span class='glyphicon @(created ? "glyphicon-plus" : "glyphicon-pencil")'></span>
                }
                @Html.Raw(songOrder.GetSortGlyph(dateId))
            </th>
        }
    </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            Song sd = null;
            if (albumName != null)
            {
                sd = item as Song;
            }
            List<DanceRating> scaledDances = null;
            if (item.DanceRatings != null)
            {
                scaledDances = item.DanceRatings.Where(dr => item.TagSummary.Tags.Any(t => string.Equals(t.Value, $"{dr.DanceName}:Dance", StringComparison.OrdinalIgnoreCase))).OrderByDescending(dr => danceStats.GetScaledRating(dr.DanceId, dr.Weight)).ToList();
            }
            string tempoString = null;
            if (item.Tempo.HasValue)
            {
                var numerator = 4;
                if (scaledDances != null && scaledDances.Count > 0)
                {
                    var did = scaledDances[0].DanceId;
                    if (!string.IsNullOrWhiteSpace(did))
                    {
                        numerator = Dances.Instance.DanceFromId(did).Meter.Numerator;
                    }
                }
                tempoString = string.Format("<a href='/home/counter?numerator={1}&tempo={0}'>{0}</a>", decimal.Round(item.Tempo.Value), numerator);
            }

            if (item.Title != null)
            {
            <tr>
                <td>
                    @{
                        if (danceId != null)
                        {
                            var danceLike = new LikeHelperModel
                            {
                                Song = item, Likes = danceLikes, Image = "dance", Modifier = $"dancing {danceName} to this song", DanceId = danceId, TipNull = likeTipNull, TipTrue = likeTipTrue, TipFalse = likeTipFalse
                            };
                            <partial name="_LikeHelper" model="@danceLike"/>
                        }

                        var songLike = new LikeHelperModel
                        {
                            Song = item, Likes = likes, Image = "heart", Modifier = "this song", DanceId = "like", TipNull = likeTipNull, TipTrue = likeTipTrue, TipFalse = likeTipFalse
                        };
                        <partial name="_LikeHelper" model="@songLike"/>
                        
                        @if (!string.IsNullOrWhiteSpace(item.Purchase))
                        {
                            var id = "Play" + item.SongId;
                            var purchase = JsonConvert.SerializeObject(item.PurchaseInfo);
                            <a href='#' id='@id' role='button' class='btn play-button' style='padding: 0'
                               data-toggle='modal' data-target='#playModal' aria-expanded='false'
                               data-song-id ='@item.SongId'
                               data-title='@item.Title' data-artist='@item.Artist'
                               data-purchase='@purchase' data-sample='@item.Sample'
                               >
                                <img src="@Url.Content("~/images/icons/playbutton.png")" alt="Play" width="20" height="20"/>
                            </a>
                        }
                    }
                </td>
                @if (isAdmin)
                {
                    var id = "Selected-" + item.SongId;
                    if (canSort)
                    {
                        <td><input name="selectedSongs" id="@id" type="checkbox" value="@item.SongId" /></td>
                    }
                    <td><a href="/song/edit?id=@item.SongId&filter=@filter" role="button" class="btn btn-link btn-sm"><span class="glyphicon glyphicon-pencil"></span></a></td>
                }

                <td>
                    @Html.ActionLink(item.Title, "details", "song", new { id = item.SongId, filter }, null)
                    @if (tempoString != null)
                    {
                        <small class="hidden-sm hidden-md hidden-lg">(@Html.Raw(tempoString) BPM)</small>
                    }
                    <span class="visible-xs"> - @artist(item)</span>
                </td>

                @if (!hideArtist)
                {
                    <td class="hidden-xs">@artist(item)</td>
                }

                @if (albumName == null)
                {
                    @*<td class="hidden-xs">
                        @if (!string.IsNullOrWhiteSpace(item.AlbumName))
                        {
                            @Html.ActionLink(item.AlbumName, "album", "song", new { title = item.AlbumName }, null)
                        }
                    </td>*@
                }
                else
                {
                    <td class="hidden-xs">
                        @{
                            var track = sd.TrackFromAlbum(albumName);
                            if (track > 0)
                            {
                                @track.ToString()
                            }
                        }
                    </td>
                }
                <td class="hidden-xs">
                    @if (tempoString != null)
                    {
                        @Html.Raw(tempoString)
                    }
                </td>
                @if (showLength)
                {
                    <td class="hidden-xs">
                        @if (item.Length != null)
                        {
                            @((new SongDuration(item.Length.Value)).ToString())
                        }
                    </td>
                }
                <td class="hidden-xs">
                    <partial name="_EchoValues" model="new EchoValuesModel {Song=@item}"/>
                </td>
                @if (!hideDances)
                {
                    <td>
                        <span class="visible-xs">
                            <partial name="_EchoValues" model="new EchoValuesModel {Song=@item}" />
                        </span>
                        @* ReSharper disable once LoopCanBeConvertedToQuery *@
                        @if (scaledDances != null)
                        {
                            foreach (var ditem in scaledDances)
                            {
                                // TODO: Dance name pulled from the danceMap doesn't require a db lookup - is there a way
                                //  to make the more intuitive ditem.Dance.Name work without a lookup???
                                var badge = danceStats.GetRatingBadge(ditem.DanceId, ditem.Weight);
                                var stats = danceStats.FromId(ditem.DanceId);
                                var name = stats.DanceName;
                                var maxWeight = stats.MaxWeight;
                                var label = name;
                                var tagModels = new List<TagModalModel>();
                                var tags = string.Empty;
                                var modalId = $"{ditem.DanceId}.{item.SongId}.modal";

                                if (!string.IsNullOrWhiteSpace(ditem.TagSummary.Summary))
                                {
                                    var idx = 0;
                                    label = label + " <span class='glyphicon glyphicon-asterisk' aria-hidden='true'></span>";
                                    foreach (var dtitem in ditem.TagSummary.Tags)
                                    {
                                        tagModels.Add(new TagModalModel
                                        {
                                            Tag = dtitem,
                                            Filter = filter,
                                            Song = item
                                        });
                                        /* CORETODO: Did TagModalBUtton as a partial, can we load a partial here? Pretty sure this kludge won't work, but try first */
                                        // TagHelpers.TagModalButton(dtitem, filter, item); 
                                        tags += $"<partial name='_TagModalButton' model='modalId[{idx}]' />";
                                        idx += 1;
                                    }
                                }
                                var hasDance = danceQuery.HasDance(ditem.DanceId);
                                var filterT = new SongFilter(filter.ToString());
                                if (hasDance ? (numDances > 1) : (numDances > 0))
                                {
                                    filterT.Action = "advanced";
                                }
                                var urlFiltered = string.Empty;
                                var urlDance = string.Empty;
                                const string baseUrl = "/song/search?dances=";
                                var url = baseUrl + ditem.DanceId;

                                if (!filter.IsRaw)
                                {
                                    url += "&filter=" + new SongFilter { Action = filter.Action, SortOrder = filter.SortOrder };
                                }

                                if (!filter.IsRaw && !filter.IsEmptyPaged && !hasDance)
                                {
                                    var dq = danceQuery.AddDance(ditem.DanceId);
                                    if (isExclusive)
                                    {
                                        urlFiltered = baseUrl + dq.MakeExclusive().Query + "&filter=" + filterT;
                                    }
                                    if (isInclusive)
                                    {
                                        urlDance = baseUrl + dq.MakeInclusive().Query + "&filter=" + filterT;
                                    }
                                }

                                <a href='#' id='@modalId'
                                    class='rating @badge label label-music' role='button'
                                    data-toggle='modal' data-target='#danceModal' aria-expanded='false'
                                    data-title='@item.Title' data-artist='@item.Artist' data-song-id='@item.SongId'
                                    data-dance-name='@name' data-dance-id='@ditem.DanceId' data-dance-weight="@ditem.Weight" data-dance-max-weight="@maxWeight"
                                    data-filtered-url="@urlFiltered" data-dance-url='@urlDance' data-url='@url'
                                    data-tags='@tags'
                                    >@Html.Raw(label)</a>
                            }
                        }
                        <span class="visible-xs">@tagList(item)</span>
                    </td>
                }
                <td class="hidden-xs">@tagList(item)</td>
                @if (hideDances)
                {
                    <td class="visible-xs">
                        <partial name ="_EchoValues" model="new EchoValuesModel { Song = item }"/>
                        @tagList(item)
                    </td>
                }

                @if (isAdmin)
                {
                    var play = item.Sample != null ? (item.Sample != "." ? "P" : "p") : string.Empty;
                    var echo = item.Danceability != null ? (float.IsNaN(item.Danceability.Value) ? "e" : "E") : string.Empty;
                    <td>@(item.Purchase + play + echo)</td>
                }

                @if (showDate)
                {
                    @time(item)
                }
            </tr>
            }
        }
    </tbody>
</table>

<partial name="_playmodal"/>
<partial name="_filtermodal"/>
<partial name="_dancemodal"/>
