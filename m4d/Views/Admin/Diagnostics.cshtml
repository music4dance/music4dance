@using System.Globalization
@using Microsoft.FeatureManagement
@using m4d.Utilities
@using m4d.ViewModels
@using m4d.Services.Diagnostics
@using m4dModels
@using System
@inject ISearchServiceManager SearchService
@inject IConfiguration Configuration
@inject IFeatureManagerSnapshot FeatureManager

@{
    ViewBag.Title = "Logging";
    ViewBag.BreadCrumbs = BreadCrumbItem.BuildAdminTrail(ViewBag.Title);
    var gcSnapshot = ViewBag.GcSnapshot as GcSnapshot;
    var gcBefore = ViewBag.GcBefore as GcSnapshot;
    var gcAfter = ViewBag.GcAfter as GcSnapshot;
    long? memoryFreed = ViewBag.MemoryFreed as long?;
    var dumpResult = ViewBag.DumpResult as DumpResult;
}

@* Status Messages *@
@if (ViewBag.Message != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @ViewBag.Message
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}
@if (ViewBag.ErrorMessage != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @ViewBag.ErrorMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<p>Start Time = <b>@SpiderManager.StartTime.ToString(CultureInfo.CurrentCulture)</b></p>
<p>Up Time = <b>@SpiderManager.UpTime.ToString()</b></p>

<hr />
<h3>Environment</h3>
<ul>
    <li>
        <b>Command Line:</b>@Environment.CommandLine
    </li>
    <li>
        <b>Current Directory:</b>@Environment.CurrentDirectory
    </li>
    <li>
        <b>OSVersion:</b> @Environment.OSVersion
    </li>
    <li>
        <b>UserDomainName:</b> @Environment.UserDomainName
    </li>
    <li>
        <b>UserName:</b> @Environment.UserName
    </li>
    <li>
        <b>Version:</b> @Environment.Version
    </li>
    <li><b>Build Flavor:</b> @(ViewBag.Debug ? "Debug" : "Release")</li>
    <li>
        Sentinel: @Configuration["Configuration:Sentinel"]
    </li>
    <li>
        CaptcahEnabled: @Configuration["Configuration:Registration:CaptchaEnabled"]
    </li>
</ul>

<hr />
<h3>Memory &amp; GC Diagnostics</h3>
@if (gcSnapshot != null)
{
    <p><small>Captured at: @gcSnapshot.CapturedAt.ToString("yyyy-MM-dd HH:mm:ss.fff")</small></p>

    <table class="table table-sm table-bordered" style="max-width: 600px;">
        <thead class="table-light">
            <tr><th colspan="2">Memory Overview</th></tr>
        </thead>
        <tbody>
            <tr>
                <td><b>Total Managed Memory</b></td>
                <td>@gcSnapshot.TotalMemoryMB.ToString("F2") MB</td>
            </tr>
            <tr>
                <td><b>Heap Size</b></td>
                <td>@gcSnapshot.HeapSizeMB.ToString("F2") MB</td>
            </tr>
            <tr>
                <td><b>Working Set</b></td>
                <td>@gcSnapshot.WorkingSetMB.ToString("F2") MB</td>
            </tr>
            <tr>
                <td><b>Memory Load</b></td>
                <td>@gcSnapshot.MemoryLoadPercent.ToString("F1")%</td>
            </tr>
        </tbody>
        <thead class="table-light">
            <tr><th colspan="2">Fragmentation</th></tr>
        </thead>
        <tbody>
            <tr>
                <td><b>Fragmented Memory</b></td>
                <td>@gcSnapshot.FragmentedMB.ToString("F2") MB (@gcSnapshot.FragmentationPercent.ToString("F1")%)</td>
            </tr>
            <tr>
                <td><b>Large Object Heap (LOH)</b></td>
                <td>@gcSnapshot.LargeObjectHeapSizeMB.ToString("F2") MB</td>
            </tr>
            <tr>
                <td><b>Pinned Object Heap (POH)</b></td>
                <td>@gcSnapshot.PinnedObjectHeapSizeMB.ToString("F2") MB</td>
            </tr>
        </tbody>
        <thead class="table-light">
            <tr><th colspan="2">GC Collection Counts</th></tr>
        </thead>
        <tbody>
            <tr>
                <td><b>Gen 0 Collections</b></td>
                <td>@gcSnapshot.Gen0Collections</td>
            </tr>
            <tr>
                <td><b>Gen 1 Collections</b></td>
                <td>@gcSnapshot.Gen1Collections</td>
            </tr>
            <tr>
                <td><b>Gen 2 Collections</b></td>
                <td>@gcSnapshot.Gen2Collections</td>
            </tr>
        </tbody>
        <thead class="table-light">
            <tr><th colspan="2">System Info</th></tr>
        </thead>
        <tbody>
            <tr>
                <td><b>Process ID</b></td>
                <td>@GcDiagnostics.GetProcessId()</td>
            </tr>
            <tr>
                <td><b>Total Available Memory</b></td>
                <td>@((gcSnapshot.TotalAvailableMemoryBytes / (1024.0 * 1024.0 * 1024.0)).ToString("F2")) GB</td>
            </tr>
        </tbody>
    </table>

    @if (gcBefore != null && gcAfter != null && memoryFreed.HasValue)
    {
        <div class="alert alert-info" style="max-width: 600px;">
            <h5>Force GC Results</h5>
            <p>
                <b>Before:</b> @gcBefore.TotalMemoryMB.ToString("F2") MB<br />
                <b>After:</b> @gcAfter.TotalMemoryMB.ToString("F2") MB<br />
                <b>Freed:</b> @((memoryFreed.Value / (1024.0 * 1024.0)).ToString("F2")) MB
            </p>
        </div>
    }

    @if (dumpResult != null)
    {
        <div class="alert @(dumpResult.Success ? "alert-success" : "alert-warning")" style="max-width: 600px;">
            <h5>Memory Dump Result</h5>
            @if (dumpResult.Success)
            {
                <p>
                    <b>File:</b> @dumpResult.FilePath<br />
                    <b>Size:</b> @dumpResult.FileSizeMB.ToString("F2") MB<br />
                    <b>Type:</b> @dumpResult.DumpType
                </p>
                <a href="@Url.Action("DownloadDump", "Admin", new { fileName = dumpResult.FileName })" class="btn btn-sm btn-primary">
                    Download Dump
                </a>
            }
            else
            {
                <p><b>Error:</b> @dumpResult.ErrorMessage</p>
            }
        </div>
    }
}
else
{
    <p><em>No GC snapshot available.</em></p>
}

<p>
    @Html.ActionLink("Capture GC Snapshot", "CaptureGcSnapshot", "Admin") |
    <span class="text-muted">Logs current memory state</span>
</p>

@using (Html.BeginForm("ForceGarbageCollection", "Admin", FormMethod.Post, new { style = "display:inline;" }))
{
    @Html.AntiForgeryToken()
    <button type="submit" class="btn btn-warning btn-sm"
            onclick="return confirm('This will force a full garbage collection. Continue?');">
        Force GC
    </button>
    <span class="text-muted ms-2">Triggers Gen2 collection with compaction</span>
}

<h5 class="mt-3">Memory Dump</h5>
@using (Html.BeginForm("CreateMemoryDump", "Admin", FormMethod.Post, new { @class = "mb-3" }))
{
    @Html.AntiForgeryToken()
    <div class="row g-2 align-items-center" style="max-width: 600px;">
        <div class="col-auto">
            <label class="col-form-label">Dump Type:</label>
        </div>
        <div class="col-auto">
            <select name="dumpType" class="form-select form-select-sm">
                <option value="Mini">Mini (smallest)</option>
                <option value="Heap" selected>Heap (recommended)</option>
                <option value="Full">Full (largest)</option>
            </select>
        </div>
        <div class="col-auto">
            <div class="form-check">
                <input type="checkbox" name="download" value="true" class="form-check-input" id="downloadCheck">
                <label class="form-check-label" for="downloadCheck">Download</label>
            </div>
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-danger btn-sm"
                    onclick="return confirm('This will create a memory dump which may be large and take time. Continue?');">
                Create Dump
            </button>
        </div>
    </div>
    <small class="text-muted">Requires dotnet-dump tool: <code>dotnet tool install -g dotnet-dump</code></small>
}

<hr />
<h3>Logging (Current Level = @(ViewData["CurrentLogLevel"] ?? "Unknown"))</h3>
<p>
    <b>Note:</b> In the Debug environment, the Developer Exception Page and some logging providers may emit all log levels regardless of runtime changes. To allow runtime log level changes, ensure your <code>appsettings.Development.json</code> does not set a minimum log level lower than what you want to allow, and avoid hard-coded log filters in <code>Program.cs</code>.
</p>
<ul>
    @foreach (var lvl in Enum.GetValues(typeof(Microsoft.Extensions.Logging.LogLevel)))
    {
        <li>
            <a href="@Url.Action("SetLogLevel", "Admin", new { level = lvl })">Set to @lvl</a>
            |
            <a href="@Url.Action("TestLog", "Admin", new { message = $"Test log for {lvl}", level = lvl })">Emit @lvl log</a>
        </li>
    }
</ul>

<h4>@Html.ActionLink("Throw an Exception", "ThrowException", "Admin")</h4>

<hr />
<h3>Features</h3>
<ul>
    @await foreach (var feature in FeatureManager.GetFeatureNamesAsync())
    {
        <li>@feature == @await FeatureManager.IsEnabledAsync(feature)</li>
    }
</ul>

<hr />
<h3>History</h3>
<ul>
    <li>
        @Html.ActionLink("Songs sorted by Modified date", "sort", "song", new
    {
        sortOrder = "Modified_desc"
    }, null)
    </li>
    <li>
        @Html.ActionLink("Songs sorted by Created date", "sort", "song", new
    {
        sortOrder = "Created_desc"
    }, null)
    </li>
    <li>
        @Html.ActionLink("All Songs", "filtersearch", "Song", new
    {
        filter = "Advanced----------3"
    })
    </li>
</ul>

<hr />
<h3>Status</h3>
<ul>
    <li>@Html.ActionLink("Show Status", "AdminStatus", "Admin")</li>
    <li>@Html.ActionLink("Reset Admin", "ResetAdmin", "Admin")</li>
    <li>
        Skipped iTunes = @MusicServiceManager.Skipped;
        Currently Paused = @MusicServiceManager.Paused
    </li>
    <li>iTunes Calls = @MusicServiceManager.iTunesCalls</li>
    <li>spotify Calls = @MusicServiceManager.spotifyCalls</li>
    <li>@Html.ActionLink("Dump Cleanup Count", "DumpCleanupCount", "Admin")</li>
</ul>

<hr />
<h3>Search Index: @ViewBag.SearchIdx</h3>
<p>Source = @ViewBag.StatsUpdateSource, Time=@ViewBag.StatsUpdateTime</p>
<ul>
    @foreach (var id in SearchService.GetAvailableIds()){
        if (SearchService.DefaultId == id)
        {
            continue;
        }
        <li>
                @Html.ActionLink(id, "SetSearchIdx", "Admin", new
            {
                id
            }, null)
        </li>
    }
</ul>
<p><b>Enviroment:</b> @SearchService.RawEnvironment</p>
<p><b>DB Code Version:</b> @SearchService.CodeVersion
<p><b>DB Config Version:</b> @SearchService.ConfigVersion
<p />

<hr />
<h3>Tag Duplicates</h3>
<ul>
    @foreach (var key in TagManager.Duplicates)
{
    <li>@key</li>
}
</ul>

<hr />
<h3>Songs Modified By</h3>
@using (Html.BeginForm("FilterUser", "Song", FormMethod.Get))
{
    <input type="text" name="user" />
    <input type="submit" id="Submit" value="Search" />
}

<hr />
<h3>ListSongs</h3>
@using (Html.BeginForm("List", "Song", FormMethod.Post, new
{
    enctype = "multipart/form-data"
}))
{
    @Html.AntiForgeryToken()
    <input type="file" name="FileUpload" />
    <input type="submit" name="list" id="List" value="List" />
}

<hr />
<h3>Bot Stats</h3>
<partial name="_botreport" model="ViewBag.BotReport" />
