@using System.Globalization
@using DanceLibrary
@using MarkdownDeep
@using m4d.Utilities
@model DanceStats

@{
    var defaultFilter = SongFilter.Default;
    var danceFilter = new SongFilter {Action = defaultFilter.Action, Dances = @Model.DanceId};

    ViewBag.Title = Model.DanceName + " Information, Top Ten List, and Resources.";
    ViewBag.Description = "General information about the dance" + Model.DanceName + " along with a top ten song list, preferred tempo details, and other resources.";
    ViewBag.NoSort = true;
    ViewBag.ShowTempo = true;
    ViewBag.HideDances = true;
    ViewBag.SongFilter = danceFilter;

    var description = @"<p>We're busy doing research and pulling together a general description for " + Model.DanceName + @".  Please check back later for more info.</p>";
    if (!string.IsNullOrWhiteSpace(Model.Description))
    {
        var md = new Markdown { ExtraMode = true, SafeMode = false };
        description = Model.Description;
        description = Dance.SmartLinks(description, true);
        description = md.Transform(description);
    }

    var tags = Model.AggregateSongTags?.Tags;

    DanceStatsInstance stats = ViewBag.DanceStats;
}

@Html.Partial("_SetupFilterScript")

<ol class="breadcrumb">
    <li><a href="/">Music4Dance</a></li>
    <li><a href="/dances">Dances</a></li>
    @if (Model.Parent != null && Model.Parent.DanceId != "All")
    {
    <li><a href="/dances/@Model.Parent.SeoName">@Model.Parent.DanceName</a></li>
    }
    <li class="active">@Model.DanceName</li>
</ol>


<h1>@Model.DanceName</h1>

<div class="row">
    <div class="col-sm-2 col-sm-offset-1 col-sm-push-8 list-group">
        <div class="visible-xs-inline">
            <a href="#dancedescription" class="list-group-item">Dance Description</a>
        </div>
        @if (Model.Parent != null && Model.DanceObject.Meter.Numerator != 1)
        {
            <a href="#tempo-info" class="list-group-item">Tempo Info</a>
        }
        @if (Model.TopSongs.Any())
        {
            <a href="#top-ten" class="list-group-item">Top Ten Songs</a>
        }
        @if (!string.IsNullOrWhiteSpace(Model.SpotifyPlaylist))
        {
            <a href="#spotify-player" class="list-group-item">@Model.DanceName Music on Spotify</a>
        }
        @if (Model.Parent == null)
        {
            <a href="#dance-styles" class="list-group-item">Dance Styles</a>
        }
        @if (Model.DanceLinks != null && Model.DanceLinks.Count > 0)
        {
            <a href="#references" class="list-group-item">References</a>
        }
        @Html.ActionLink("All " + @Model.DanceName + " Songs", "index", "song", new { filter = @danceFilter }, new { @class = "list-group-item" })
        @if (tags?.Count > 0)
        {
            <a href="#tags" class="list-group-item">Tags</a>
        }
        @if (!string.IsNullOrWhiteSpace(Model.BlogTag))
        {
            var blogref = string.Format("https://music4dance.blog/tag/{0}/", Model.BlogTag);
            <a href="@blogref" class="list-group-item">Blog</a>
        }
    </div>
        <div class="col-sm-8 col-sm-pull-3">
            <section id="dancedescription">
                <div class="big-text">@Html.Raw(description)</div>
            </section>
            <section id="tempo-info">
                @if (@Model.Parent != null && Model.DanceObject.Meter.Numerator != 1)
                {
                    var info = Model.DanceObject;
                    var tempo = info.TempoRange;
                    var oneTempo = tempo.Min == tempo.Max;
                    var bpmMin = tempo.Min*info.Meter.Numerator - (oneTempo?0.5m:0);
                    var bpmMax = tempo.Max*info.Meter.Numerator + (oneTempo ? 0.5m : 0);
                    var rangeText = (oneTempo) ? "at" : "between";
                    var bpmText = bpmMin.ToString(CultureInfo.CurrentCulture) + (oneTempo ? string.Empty : " and " + bpmMax.ToString(CultureInfo.CurrentCulture)) + " beats per minute";
                    var mpmText = tempo.MinString + (oneTempo ? string.Empty : " and " + tempo.MaxString) + " measures per mintue";
                <hr />
                <h4>Tempo Information</h4>
                <p class="big-text">
                    The @Model.DanceName is generally danced to music in a @info.Meter Meter
                    @rangeText @mpmText (@bpmText)
                    . @Html.ActionLink("Click here", "advancedsearch", "song", new {dances = @Model.DanceId, tempomin = @bpmMin, tempomax = @bpmMax, filter=@defaultFilter}, null) to see a list of @Model.DanceName songs @rangeText @bpmText.
                </p>
                <dl>
                    @SmartLink.TempiTool()
                </dl>
                }
            </section>
        </div>
</div>
<hr />

@if (Model.TopSongs.Any())
{
    <section id="top-ten">
        <div>
            <h3>@Html.ActionLink("music4dance's", "Index", "Home") top 10 songs for dancing @Html.ActionLink(@Model.DanceName, "index", "song", new {filter = @danceFilter}, null)</h3>
        </div>
        <div>
            @{Html.RenderPartial("_ListSongs", Model.TopSongs.Take(10), ViewData);}
        </div>
    </section>


    if (!string.IsNullOrWhiteSpace(Model.SpotifyPlaylist))
    {
        <section id="spotify-player">
            <H4>@Model.DanceName Spotify Playlist</H4>
            <iframe src="https://open.spotify.com/embed/user/ebo1rk39vp51kkyjps45eobph/playlist/@Model.SpotifyPlaylist" frameborder="0" width="300" height="80" allowtransparency="true" allow="encrypted-media" allow="encrypted-media"></iframe>
        </section>
    }

    <div>
        <p class="big-text">@Html.ActionLink("Browse", "index", "song", new { filter = @danceFilter }, null) all <b>@Model.SongCount</b> @Model.DanceName songs in the music4dance @Html.ActionLink("catalog", "index", "song" , new {filter=@defaultFilter}, null).</p>
    </div>
}

@if (@Model.CompetitionDances != null)
{
<section id="category-info">
    @DanceHelper.CategoryTable(Html,stats,Model.CompetitionDances,"Competition Tempo information:",DanceCategoryType.Both)
</section>
}

@if (@Model.Parent == null)
{
<hr />
<section id="dance-styles">
    <h4>Dances that are grouped into the @Model.DanceName category.</h4>
    <div class="list-group">
        @{Html.RenderPartial("_DanceList", @Model.Children);}
    </div>
</section>
}

@if (Model.DanceLinks != null && Model.DanceLinks.Count > 0)
{
    <hr/>
    <section id="references">
    <h4>References</h4>
    <ul>
        @foreach (var dl in Model.DanceLinks)
        {
        <li><b>@dl.Description:</b> <a href="@dl.Link">@dl.Link</a></li>
        }
    </ul>
    </section>
}

@if (tags?.Count > 0)
{
    <hr/>
    <section id="tags"></section>
    <h4>Tags</h4>
    Html.RenderPartial("_TagCloud", tags);
}

<p>
    @if (User.IsInRole("canEdit"))
    {
    @Html.ActionLink("Edit", "Edit", new { id = Model.DanceId }, new { @class = "btn btn-default", role = "button" })
    }
</p>

@if (User.IsInRole("showDiagnostics"))
{
    @DanceHelper.ShowAdmin(Model)
}

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    @Scripts.Render("~/bundles/knockout")
    @Scripts.Render("~/bundles/musicservice")
    @Scripts.Render("~/bundles/showdance")
}

