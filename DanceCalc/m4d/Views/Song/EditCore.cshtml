@model m4dModels.SongDetails

@using (Html.BeginForm((string)ViewBag.Action, "Song", null, FormMethod.Post, new { @class="form-horizontal"}))
{
    @Html.AntiForgeryToken()
    @Html.ValidationSummary(true)

    m4dModels.SongDetails old = null;

    try
    {
        old = ViewBag.OldSong;
    }
    catch (Microsoft.CSharp.RuntimeBinder.RuntimeBinderException)
    {

    }

    @Html.HiddenFor(model => model.SongId)

    <div class="form-group">
        @Html.LabelFor(model => model.Title, new { @class = "control-label col-md-2" })
        <div class="col-md-10">
            @Html.EditorFor(model => model.Title)
            @Html.ValidationMessageFor(model => model.Title)
            @if (old != null && !string.IsNullOrWhiteSpace(old.Title))
            {
                <div class="editor-alternate">
                    @old.Title
                </div>
            }
        </div>
    </div>
    
    <div class="form-group">
        @Html.LabelFor(model => model.Artist, new { @class = "control-label col-md-2" })
        <div class="col-md-10">
            @Html.EditorFor(model => model.Artist)
            @Html.ValidationMessageFor(model => model.Artist)
            @if (old != null && !string.IsNullOrWhiteSpace(old.Artist))
            {
                <div class="editor-alternate">
                    @old.Artist
                </div>
            }
        </div>
    </div>
    
    <!-- Album stuff goes here-->

    <div class="form-group">
        @Html.LabelFor(model => model.Length, new { @class = "control-label col-md-2" })
        <div class="col-md-10">
            @Html.EditorFor(model => model.Length,"SongDuration")
            @*@Html.ValidationMessageFor(model => model.Length)*@

            @if (old != null && old.Length != null)
            {
                <div class="editor-alternate">
                    @old.Length.Value
                </div>
            }
            </div>
    </div>

    <div class="form-group">
        @Html.LabelFor(model => model.Genre, new { @class = "control-label col-md-2" })
        <div class="col-md-10">
            @Html.EditorFor(model => model.Genre)
            @Html.ValidationMessageFor(model => model.Genre)

            @if (old != null && old.Genre != null)
            {
                <div class="editor-alternate">
                    @old.Genre
                </div>
            }
            </div>
    </div>

    <div class="form-group">
        @Html.LabelFor(model => model.Tempo, new { @class = "control-label col-md-2" })
        <div class="col-md-10">
            @Html.EditorFor(model => model.Tempo)
            @Html.ValidationMessageFor(model => model.Tempo)

            @if (old != null && old.Tempo != null)
            {
                <div class="editor-alternate">
                    @old.Tempo.Value
                </div>
            }
            <a href="#" id="toggle-count" class="btn btn-sm btn-default"><span id="toggle-count-display" class="glyphicon glyphicon-arrow-down"></span></a>
        </div>
    </div>
    <div class="form-group" id="counter-control">
        <div class="col-md-2"></div>
        <div class="col-md-8">
            <button id='count' type=button class="btn btn-lg btn-primary btn-block">Count</button>
            <div>@Html.Partial("_MeterChooser")</div>
            <div id="dances" class="list-group"></div>
            <input id='epsilon' type='range' value='5' min='1' max='50' />
        </div>
        <div class="col-md-2"></div>
    </div>
    <hr />
    <div class="display-label">
        Dance(s):
    </div>
    <div class="display-field">
        @{ var separator = ""; }
        @if (Model.DanceRatings != null)
    {
        foreach (var item in Model.DanceRatings)
        {
            @separator;
            @Html.DisplayFor(model => item.Dance.Info.Name)
            if (item.Weight > 1)
            {
                <b>(@item.Weight)</b>
            }
            separator = ", ";
        }
        <br />
    }
    </div>

    if (ViewData.ContainsKey("DanceListRemove"))
    {
    <div class="editor-label">
        Remove Dances from this list to vote them down.
    </div>
    <div class="editor-field">
        @Html.ListBox("remDances", ViewBag.DanceListRemove as MultiSelectList, new { @class = "chzn-select", data_placeholder = "Remove Dances to Vote Down..." })
    </div>
    }
    if (ViewData.ContainsKey("DanceListAdd"))
    {
    <div class="editor-label">
        Add dances to this list to vote them up.
    </div>
    <div class="editor-field">
        @Html.ListBox("addDances", ViewBag.DanceListAdd as MultiSelectList, new { @class = "chzn-select", data_placeholder = "Choose Dances to Vote Up..." })
    </div>
    <br />
    }

    <hr />
    <table>
        <tr><td class="album-header">Album</td><td class="track-header">Track</td><td class="publisher-header">Label</td><td class="delete-header"></td></tr>
        @{
        int currentAlbum = 0;
        int maxAlbum = 5;
        if (Model.HasAlbums)
        {
            maxAlbum = Model.Albums.Count + 5;
            for (; currentAlbum < Model.Albums.Count; currentAlbum++)
            {
                string albumId = "Album_" + currentAlbum.ToString();
                string deleteId = "Delete_" + currentAlbum.ToString();
                //string purchase = Model.Albums[currentAlbum].SerializePurchaseInfo();
                <tr id="@albumId">
                    <td>
                        <div class="editor-field">
                            @Html.TextBoxFor(model => model.Albums[currentAlbum].Name)
                            @Html.ValidationMessageFor(model => model.Albums[currentAlbum].Name)
                        </div>
                    </td>
                    <td>
                        <div class="editor-field">
                            @Html.TextBoxFor(model => model.Albums[currentAlbum].Track)
                            @Html.ValidationMessageFor(model => model.Albums[currentAlbum].Track)
                        </div>
                    </td>
                    <td>
                        <div class="editor-field">
                            @Html.TextBoxFor(model => model.Albums[currentAlbum].Publisher)
                            @Html.ValidationMessageFor(model => model.Albums[currentAlbum].Publisher)
                        </div>
                    </td>
                    <td>
                        <button type="button" id="@deleteId">X</button>
                        @Html.HiddenFor(model => Model.Albums[currentAlbum].PurchaseInfo)
                        @Html.HiddenFor(model => Model.Albums[currentAlbum].Index)
                    </td>
                </tr>
            }
        }
        else
        {
            Model.Albums = new List<m4dModels.AlbumDetails>();
        }

        int albumIdx = Model.GetNextAlbumIndex();

        for (; currentAlbum < maxAlbum; currentAlbum += 1)
        {
            string albumId = "Album_" + currentAlbum.ToString();
            Model.Albums.Add(new m4dModels.AlbumDetails { Index = albumIdx++ });
            <tr id="@albumId" hidden>
                <td>
                    <div class="editor-field">
                        @Html.TextBoxFor(model => model.Albums[currentAlbum].Name)
                        @Html.ValidationMessageFor(model => model.Albums[currentAlbum].Name)
                    </div>
                </td>
                <td>
                    <div class="editor-field">
                        @Html.TextBoxFor(model => model.Albums[currentAlbum].Track)
                        @Html.ValidationMessageFor(model => model.Albums[currentAlbum].Track)
                    </div>
                </td>
                <td>
                    <div class="editor-field">
                        @Html.TextBoxFor(model => model.Albums[currentAlbum].Publisher)
                        @Html.ValidationMessageFor(model => model.Albums[currentAlbum].Publisher)
                    </div>
                </td>
                <td>
                    @Html.HiddenFor(model => Model.Albums[currentAlbum].Index)
                </td>
            </tr>
        }

        <tr>
            <td colspan="3"><button type="button" id="AddAlbum">New Album</button></td>
        </tr>
        }
    </table>
    <hr />
    <a id="load-xbox" href="#" class="btn btn-small btn-default" role="button">Xbox</a>
    <a id="load-itunes" href="#" class="btn btn-small btn-default" role="button">ITunes</a>
    <a id="load-amazon" href="#" class="btn btn-small btn-default" role="button">Amazon</a>
    <a id="load-all" href="#" class="btn btn-small btn-default" role="button">All</a>

    <table id="service-results" class="table table-striped">
        <thead>
            <tr>
                <th></th>
                <th></th>
                <th>Name</th>
                <th>Album</th>
                <th>Artist</th>
                <th>#</th>
                <th>Length</th>
            </tr>
        </thead>
        <tbody data-bind="foreach: tracks">
            <tr>
                <td><a data-bind="attr: {href: Link}" class="btn" role="button"><img width="30" height="30" data-bind="attr: {src: serviceLogo}" /></a></td>
                <td><img width="30" height="30" data-bind="attr: {src: ImageUrl}" /></td>
                <td data-bind="text: Name"></td>
                <td data-bind="text: Album"></td>
                <td data-bind="text: Artist"></td>
                <td data-bind="text: TrackNumber"></td>
                <td data-bind="text: durationFormatted"></td>
            </tr>
        </tbody>
    </table>
    <hr />
    <div class="display-label">
        @Html.DisplayNameFor(model => model.Created):
    </div>
    <div class="display-field">
        @Html.DisplayFor(model => model.Created)
        @Html.HiddenFor(model => model.Created)
    </div>
    <br />

    <div class="display-label">
        @Html.DisplayNameFor(model => model.Modified):
    </div>
    <div class="display-field">
        @Html.DisplayFor(model => model.Modified)
    </div>

    <hr />

    <p>
        <input type="hidden" name="filter" value="@ViewBag.SongFilter" />
        <input type="submit" value="@ViewBag.Submit" class="btn btn-default" />
    </p>
    }

