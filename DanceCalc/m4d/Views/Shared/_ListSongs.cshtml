@using DanceLibrary
@using m4dModels
@model IEnumerable<SongBase>

@{
    var isAdmin = User.IsInRole("dbAdmin");        
    var canSort = ViewData.ContainsKey("NoSort") ? !ViewBag.NoSort : true;
    var hideDances = ViewData.ContainsKey("HideDances") ? ViewBag.HideDances : false;
    string albumName = ViewData.ContainsKey("AlbumName") ? ViewBag.AlbumName : null;    
    var hideArtist = ViewData.ContainsKey("HideArtist") ? ViewBag.HideArtist : false;
    var showLength = ViewData.ContainsKey("ShowLength") ? ViewBag.ShowLength : false;
    
    var danceMap = (IDictionary<string, m4dModels.SongCounts>)ViewBag.DanceMap;
    var songOrder = new m4dModels.SongSort(ViewBag.SongFilter.SortOrder);
    var showDate = songOrder.Id == "Modified" || songOrder.Id == "Created";
}

<table class="table table-striped table-songs">
    <thead>
        <tr>
            <th style="min-width: 30px">Play</th>
            @if (isAdmin)
            {
                <th>&nbsp;</th>
                if (canSort)
                {
                    <th>&nbsp;</th>
                }
            }
            <th style="min-width:75pt">
                @if (canSort)
                {
                    @Html.ActionLink("Title", "Sort", "Song", new { sortOrder = "Title", filter = ViewBag.SongFilter }, null)
                    @Html.Raw(songOrder.GetSortGlyph("Title"))
                }
                else
                {
                    <text>Title</text>
                }
            </th>
            @if (!hideArtist)
            {
                <th style="min-width:75pt">
                    @if (canSort)
                    {
                        @Html.ActionLink("Artist", "Sort", "Song", new { sortOrder = "Artist", filter = ViewBag.SongFilter }, null)
                        @Html.Raw(songOrder.GetSortGlyph("Artist"))
                    }
                    else
                    {
                        <text>Artist</text>
                    }
                </th>
            }            
            @if (albumName == null)
            {
                @* TODO: Reinstate album name when we get user selectable columns
                    <th style="min-width:75pt" class="hidden-xs">
                    @if (canSort)
                    {
                        @Html.ActionLink("Album", "Sort", "Song", new { sortOrder = "Album", filter = ViewBag.SongFilter }, null)
                        @Html.Raw(songOrder.GetSortGlyph("Album"))
                    }
                    else
                    {
                        <text>Album</text>
                    }
                </th>*@
            }
            else
            {
                <th style="min-width:75pt" class="hidden-xs">
                    Track
                </th>
            }
            <th class="hidden-xs">
                @if (canSort)
                {
                    @Html.ActionLink("Tempo (BPM)", "sort", "song", new {sortOrder = "Tempo", filter = ViewBag.SongFilter}, null)
                    @Html.Raw(songOrder.GetSortGlyph("Tempo"))
                }
                else
                {
                    <text>Tempo (BPM)</text>
                }
            </th>
            @if (showLength)
            {
                <th class="hidden-xs">
                    Length
                </th>
            }


            @if (!hideDances)
            {
                <th>
                    @if (canSort)
                    {
                        @Html.ActionLink("Dances", "sort", "song", new { sortOrder = "Dances", filter = ViewBag.SongFilter }, null)
                        @Html.Raw(songOrder.GetSortGlyph("Dances"))
                    }
                    else
                    {
                        <text>Dances</text>
                    }
                </th>
            }
            <th>
                Tags
                @if (!string.IsNullOrWhiteSpace(ViewBag.SongFilter.Tags))
                {
                    var tags = new TagList(ViewBag.SongFilter.Tags);
                    var inc = tags.ExtractAdd();
                    var exc = tags.ExtractRemove();
                    if (!inc.IsEmpty)
                    {
                        <br/><span>Included:</span>
                        foreach (var tag in inc.Tags)
                        {
                            var rg = tag.Split(':');
                            var url = "/song/removetags?tags=" + WebUtility.UrlEncode(tag) + "&filter=" + WebUtility.UrlEncode(ViewBag.SongFilter.ToString());
                            <span class="label label-@rg[1].ToLower()" style="margin-right: 5px"><a role="button" class="tag-text" href="@url">@rg[0] <span class="glyphicon glyphicon-remove-sign"></span></a></span>
                        }

                    }
                    if (!exc.IsEmpty)
                    {
                        <br /><span>Excluded:</span>
                        foreach (var tag in exc.Tags)
                        {
                            var rg = tag.Split(':');
                            var url = "/song/removetags?tags=" + WebUtility.UrlEncode(tag) + "&filter=" + WebUtility.UrlEncode(ViewBag.SongFilter.ToString());
                            <span class="label label-@rg[1].ToLower()" style="margin-right: 5px"><a role="button" class="tag-text" href="@url">@rg[0] <span class="glyphicon glyphicon-remove-sign"></span></a></span>
                        }

                    }
                }
            </th>
            @if (isAdmin)
            {
                <th></th>
            }
            @if (showDate)
            {
                <th class="hidden-xs">@ViewBag.SongFilter.SortOrder</th>
            }
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            m4dModels.SongDetails sd = null;
            if (albumName != null)
            {
                sd = item as m4dModels.SongDetails;
            }

            if (item.Title != null)
            {
                <tr>
                    <td>
                        @if (!string.IsNullOrWhiteSpace(item.Purchase))
                        {
                            var id = "Play" + item.SongId;
                            <div class="btn-group">
                                <a href="#" id="@id" role="button" class="btn dropdown-toggle" data-toggle="dropdown" aria-expanded="false"><img src="@Url.Content("~/Content/playbutton.png")" alt="Play" width="20" height="20" /></a>
                                <ul class="dropdown-menu" role="menu">
                                    @if (!string.IsNullOrEmpty(item.Purchase) && item.Purchase.Contains('X'))
                                    {
                                        var xid = "X" + item.SongId;
                                        <li><a href="#" id="@xid" class="play-link"><img src='@Url.Content("~/Content/xbox-logo.png")' alt="Availiable on Xbox Music" width="20" height="20" /> Xbox Music</a></li>
                                    }
                                    @if (!string.IsNullOrEmpty(item.Purchase) && item.Purchase.Contains('I'))
                                    {
                                        var iid = "I" + item.SongId;
                                        <li><a href="#" id="@iid" class="play-link"><img src='@Url.Content("~/Content/itunes-logo.png")' alt=" availiable on itunes" width="20" height="20" /> ITunes</a></li>
                                    }
                                    @if (!string.IsNullOrEmpty(item.Purchase) && item.Purchase.Contains('A'))
                                    {
                                        var aid = "A" + item.SongId;
                                        <li><a href="#" id="@aid" class="play-link"><img src='@Url.Content("~/Content/amazon-logo.png")' alt=" availiable at amazon" width="20" height="20" /> Amazon</a></li>
                                    }
                                    @if (!string.IsNullOrEmpty(item.Purchase) && item.Purchase.Contains('S'))
                                    {
                                        var aid = "S" + item.SongId;
                                        <li><a href="#" id="@aid" class="play-link"><img src='@Url.Content("~/Content/spotify-logo.png")' alt=" availiable on spotify" width="20" height="20" /> Spotify</a></li>
                                    }
                                </ul>
                            </div>
                        }
                    </td>
                    @if (isAdmin)
                    {
                        var id = "Selected-" + item.SongId;
                        if (canSort)
                        {
                            <td><input name="selectedSongs" id="@id" type="checkbox" value="@item.SongId" /></td>
                        }
                        <td><a href="/song/edit?id=@item.SongId&filter=@ViewBag.SongFilter" role="button" class="btn btn-link btn-sm"><span class="glyphicon glyphicon-pencil"></span></a></td>
                    }

                    <td>
                        @Html.ActionLink(item.Title, "details", "song", new { id = item.SongId, filter = ViewBag.SongFilter }, null)
                        @if (item.Tempo != null)
                        {
                            <small class="hidden-sm hidden-md hidden-lg">(@decimal.Round(item.Tempo.Value).ToString("F0") BPM)</small>
                        }
                    </td>

                    @if (!hideArtist)
                    {
                        <td>
                            @if (!string.IsNullOrWhiteSpace(item.Artist))
                            {
                                @Html.ActionLink(item.Artist, "search", "song", new { searchString = item.Artist, dances = "ALL" }, null)
                            }
                        </td>
                    }

                    @if (albumName == null)
                    {
                        @*<td class="hidden-xs">
                            @if (!string.IsNullOrWhiteSpace(item.AlbumName))
                            {
                                @Html.ActionLink(item.AlbumName, "album", "song", new { title = item.AlbumName }, null)
                            }
                        </td>*@
                    }
                    else
                    {
                        <td class="hidden-xs">
                            @{
                                var track = sd.TrackFromAlbum(albumName);
                                if (track > 0)
                                {
                                    @track.ToString()
                                }
                            }
                        </td>
                    }
                    <td class="hidden-xs">
                        @if (item.Tempo != null)
                        {
                            @(decimal.Round(item.Tempo.Value).ToString("F0"))
                        }
                    </td>
                    @if (showLength)
                    {
                        <td class="hidden-xs">
                            @if (item.Length != null)
                            {
                                @((new SongDuration(item.Length.Value)).ToString());
                            }
                        </td>
                    }
                    @if (!hideDances)
                    {
                        <td>
                            @foreach (var ditem in item.DanceRatings.OrderByDescending(dr => m4dModels.SongCounts.GetScaledRating(danceMap, dr.DanceId, dr.Weight)))
                            {
                                // TODO: Dance name pulled from the danceMap doesn't require a db lookup - is there a way
                                //  to make the more intuitive ditem.Dance.Name work without a lookup???
                                var badge = m4dModels.SongCounts.GetRatingBadge(danceMap, ditem.DanceId, ditem.Weight);
                                var name = danceMap[ditem.DanceId].DanceName;
                                <span class="rating @badge" style="margin-right: 5px">@Html.ActionLink(name, name, "dances")</span>
                            }
                        </td>
                    }
                    <td>
                        @foreach (var titem in item.TagSummary.Tags)
                        {
                            var tc = titem.TagClass.ToLower();
                            if (tc != "dance")
                            {
                                var url = "/song/addtags?tags={0}" + WebUtility.UrlEncode(titem.TagValue) + ":" + WebUtility.UrlEncode(titem.TagClass) +
                                    "&filter=" + WebUtility.UrlEncode(ViewBag.SongFilter.ToString());

                                <div class="btn-group">
                                    <a href="#" role="button" class="dropdown-toggle label label-@tc" data-toggle="dropdown" aria-expanded="false">@titem.TagValue</a>
                                    <ul class="dropdown-menu" role="menu">
                                        <li><a href="@string.Format(url,"%2B")">Include songs tagged as @titem.TagValue</a></li>
                                        <li><a href="@string.Format(url,"%2D")">Exclude songs tagged as @titem.TagValue</a></li>
                                    </ul>
                                </div>
                            }
                        }
                    </td>


                    @if (isAdmin)
                    {
                        <td>@item.Purchase</td>
                    }

                    @if (showDate)
                    {
                        <td class="hidden-xs">
                            @if (songOrder.Id == "Created")
                            {
                                <text>@item.Created.ToString("g")</text>
                            }
                            else
                            {
                                <text>@item.Modified.ToString("g")</text>
                            }
                        </td>
                    }

                </tr>
            }
        }
    </tbody>

</table>
