@using DanceLibrary
@model IEnumerable<SongBase>

@{
    var isAdmin = User.IsInRole("dbAdmin");
    var canSort = ViewData.ContainsKey("NoSort") ? !ViewBag.NoSort : true;
    var hideDances = ViewData.ContainsKey("HideDances") ? ViewBag.HideDances : false;
    string albumName = ViewData.ContainsKey("AlbumName") ? ViewBag.AlbumName : null;
    var hideArtist = ViewData.ContainsKey("HideArtist") ? ViewBag.HideArtist : false;
    var showLength = ViewData.ContainsKey("ShowLength") ? ViewBag.ShowLength : false;

    var danceMap = (IDictionary<string, SongCounts>)ViewBag.DanceMap;
    var songOrder = new SongSort(ViewBag.SongFilter.SortOrder);
    var showDate = canSort;
    SongFilter filter = ViewData.ContainsKey("SongFilter") ? ViewBag.SongFilter : new SongFilter();
    var danceId = ViewData.ContainsKey("DanceId") ? ViewBag.DanceId : null;
    var danceName = (danceId == null) ? null : danceMap[danceId].DanceName;
    LikeDictionary likes = ViewData.ContainsKey("Likes") ? ViewBag.Likes : null;
    LikeDictionary danceLikes = ViewData.ContainsKey("DanceLikes") ? ViewBag.DanceLikes : null;

    const string likeTipNull = "Click to like/dislike {0}.";
    const string likeTipTrue = "You have liked {0}, click to dislike";
    const string likeTipFalse = "You have disliked {0}, click to reset";
}

@helper ArtistHeader(bool canSort, SongSort songOrder, SongFilter filter)
{
    if (canSort)
    {
        @Html.ActionLink("Artist", "Sort", "Song", new { sortOrder = "Artist", filter }, null)
        @Html.Raw(songOrder.GetSortGlyph("Artist"))
    }
    else
    {
        <text> Artist </text>
    }
}

@helper Artist(SongBase song)
{
    if (!string.IsNullOrWhiteSpace(song.Artist))
    {
        @Html.ActionLink(song.Artist, "search", "song", new { searchString = song.Artist, dances = "ALL" }, null)
    }
}

@helper TagHeader(SongFilter filter)
{
    <text>Tags</text>
    if (!string.IsNullOrWhiteSpace(filter.Tags))
    {
        var tags = new TagList(filter.Tags);
        var inc = tags.ExtractAdd();
        var exc = tags.ExtractRemove();
        if (!inc.IsEmpty)
        {
            <br /><span> Included:</span>
            foreach (var tag in inc.Tags)
            {
                if (!tag.Contains(':')) { continue; }

                var rg = tag.Split(':');
                var url = "/song/removetags?tags=" + WebUtility.UrlEncode(tag) + "&filter=" + WebUtility.UrlEncode(filter.ToString());
                var img = "/Content/" + TagType.ClassToName(rg.Length > 0 ? rg[1] : "tag") + "-50.png";
                <span class="label label-@rg[1].ToLower()" style="margin-right: 5px"><a role="button" class="tag-text" href="@url"><img src="@img" height="12" width="12" />@rg[0] <span class="glyphicon glyphicon-remove-sign"></span></a></span>
            }
        }
        if (!exc.IsEmpty)
        {
            <br /><span>Excluded:</span>
            foreach (var tag in exc.Tags)
            {
                var rg = tag.Split(':');
                var url = "/song/removetags?tags=" + WebUtility.UrlEncode(tag) + "&filter=" + WebUtility.UrlEncode(filter.ToString());
                <span class="label label-@rg[1].ToLower()" style="margin-right: 5px"><a role="button" class="tag-text" href="@url">@rg[0] <span class="glyphicon glyphicon-remove-sign"></span></a></span>
            }
        }
    }
}

@helper Tags(SongBase song, SongFilter filter)
{
    foreach (var titem in song.TagSummary.Tags.Where(t => !string.Equals(t.TagClass, "dance", StringComparison.OrdinalIgnoreCase)))
    {
        @TagHelpers.TagButton(titem, filter)
    }
}

@helper TimeHelper(SongBase song, SongSort order)
{
    var created = order.Id == "Created";
    var prefix = created ? "Created" : "Last modified";
    var time = created ? song.Created : song.Modified;
    var delta = created ? song.CreatedOrderVerbose : song.ModifiedOrderVerbose;
    var timeMessage = prefix + " on " + time.ToString("g") + " (" + delta + " ago)";

    <td class="hidden-xs" data-toggle="tooltip" data-placement="left" title="@timeMessage">
        @(created? @song.CreatedOrder : @song.ModifiedOrder)
    </td>
}

@helper Purchase(SongBase song, char id, string logo, string title, string help)
{
    if (string.IsNullOrEmpty(song.Purchase) || !song.Purchase.Contains(id))
    {
        return;
    }

    var buttonId = string.Format("{0}{1}", id, song.SongId);
    var link = string.Format("~/Content/{0}-logo.png", logo);
    <li ><a href = "#" id = "@buttonId" class="play-link"><img src="@Url.Content(link)" alt="@help" width="20" height="20" /> @title</a></li>
}

@helper LikeHelper(SongBase song, LikeDictionary likes, string img, string modifier, string danceId, string tipNull, string tipTrue, string tipFalse)
{
    bool? like;
    if (likes == null || !likes.TryGetValue(song.SongId, out like))
    {
        like = null;
    }
    var heart = "outline-";
    var heartAlt = "No Opinion";
    var heartTip = string.Format(tipNull, modifier);
    var href = "#";
    var state = "null";

    if (likes == null)
    {
        heartTip = "Sign In to like/dislike {0}.";
        href = "/account/signin?ReturnUrl=" + Request.Url;
    }
    else if (like.HasValue)
    {
        if (like.Value)
        {
            heart = string.Empty;
            state = "true";
            heartAlt = "Like";
            heartTip = tipTrue;
        }
        else
        {
            heart = "broken-";
            state = "false";
            heartAlt = "Dislike";
            heartTip = tipFalse;
        }
    }

    var type = danceId ?? "like";
    <a id = "@type.@song.SongId" class="btn btn-sm btn-info @(likes == null ? string.Empty : "toggle-like")" style="padding:3px" role="button" href="@href" data-like="@state" data-toggle="tooltip" data-placement="right" title="@string.Format(heartTip,modifier)">
        <img src='@Url.Content(string.Format("~/Content/{0}-{1}icon.png",img, heart))' alt="@heartAlt" />
    </a>
}


<script>
    window.VoteOptions = {
        'true': { tip: '@likeTipTrue', img: '' },
        'false': { tip: '@likeTipFalse', img: '-broken' },
        'null': { tip: '@likeTipNull', img: '-outline' }
    };
</script>

<table class="table table-striped table-songs">
    <thead>
    <tr>
        <th style="width:@(danceId==null?"75":"120")px">Like/Play</th>

        @if (isAdmin)
        {
            <th>&nbsp;</th>
            if (canSort)
            {
                <th>&nbsp;</th>
            }
        }
        <th style="min-width:75px">
            @if (canSort)
            {
                @Html.ActionLink("Title", "Sort", "Song", new {sortOrder = "Title", filter}, null)
                @Html.Raw(songOrder.GetSortGlyph("Title"))
            }
            else
            {
                <text>Title</text>
            }
            @if (!hideArtist)
            {
                <span class="visible-xs"> - @ArtistHeader(canSort, songOrder, filter)</span>
            }
        </th>
        @if (!hideArtist)
        {
            <th class="hidden-xs" style="min-width:75px">
                @ArtistHeader(canSort, songOrder, filter)
            </th>
        }
        @if (albumName == null)
        {
                @* TODO: Reinstate album name when we get user selectable columns
                    <th style="min-width:75pt" class="hidden-xs">
                    @if (canSort)
                    {
                        @Html.ActionLink("Album", "Sort", "Song", new { sortOrder = "Album", filter }, null)
                        @Html.Raw(songOrder.GetSortGlyph("Album"))
                    }
                    else
                    {
                        <text>Album</text>
                    }
                </th>*@
        }
        else
        {
            <th style="min-width:75px" class="hidden-xs">
                Track
            </th>
        }
        <th class="hidden-xs">
            @if (canSort)
            {
                @Html.ActionLink("Tempo (BPM)", "sort", "song", new {sortOrder = "Tempo", filter}, null)
                @Html.Raw(songOrder.GetSortGlyph("Tempo"))
            }
            else
            {
                <text>Tempo (BPM)</text>
            }
        </th>
        @if (showLength)
        {
            <th class="hidden-xs">
                Length
            </th>
        }


        @if (!hideDances)
        {
            <th style="max-width:200px">
                @if (canSort)
                {
                    @Html.ActionLink("Dances", "sort", "song", new {sortOrder = "Dances", filter}, null)
                    @Html.Raw(songOrder.GetSortGlyph("Dances"))
                }
                else
                {
                    <text>Dances</text>
                }
                <span class="visible-xs"> - @TagHeader(filter)</span>
            </th>
        }
        <th style="max-width:200px" class="@(hideDances ? string.Empty : "hidden-xs")">@TagHeader(filter)</th>
        @if (isAdmin)
        {
            <th></th>
        }
        @if (showDate)
        {
            var created = (songOrder.Id == "Created");
            var dateId = created ? "Created" : "Modified";
            <th class="hidden-xs" style="min-width:50px">
                <a href="@Url.Action("sort", "song", new {sortOrder = dateId, filter})"><span class='glyphicon @(created ? "glyphicon-plus" : "glyphicon-pencil")'></span></a>
                @Html.Raw(songOrder.GetSortGlyph(dateId))
            </th>
        }
    </tr>
    </thead>
    <tbody>
        @foreach (var item in Model)
        {
            SongDetails sd = null;
            if (albumName != null)
            {
                sd = item as SongDetails;
            }
            List<DanceRating> scaledDances = null;
            if (item.DanceRatings != null)
            {
                scaledDances = item.DanceRatings.OrderByDescending(dr => SongCounts.GetScaledRating(danceMap, dr.DanceId, dr.Weight)).ToList();
            }
            string tempoString = null;
            if (item.Tempo.HasValue)
            {
                var numerator = 4;
                if (scaledDances != null && scaledDances.Count > 0)
                {
                    var did = scaledDances[0].DanceId;
                    if (!string.IsNullOrWhiteSpace(did))
                    {
                        numerator = Dances.Instance.DanceFromId(did).Meter.Numerator;
                    }
                }
                tempoString = string.Format("<a href='/home/counter?numerator={1}&tempo={0}'>{0}</a>", decimal.Round(item.Tempo.Value), numerator);
            }

            if (item.Title != null)
            {
            <tr>
                <td>
                    @{
                        if (danceId != null)
                        {
                            @LikeHelper(item, danceLikes, "dance", "dancing " + danceName + " to this song", danceId, likeTipNull, likeTipTrue, likeTipFalse);
                        }
                        @LikeHelper(item, likes, "heart", "this song", "like", likeTipNull, likeTipTrue, likeTipFalse);
                        if (!string.IsNullOrWhiteSpace(item.Purchase))
                        {
                            var id = "Play" + item.SongId;
                            <div class="btn-group">
                                <a href="#" id="@id" role="button" class="btn dropdown-toggle"  style="padding:0" data-toggle="dropdown" aria-expanded="false"><img src="@Url.Content("~/Content/playbutton.png")" alt="Play" width="20" height="20"/></a>
                                <ul class="dropdown-menu" role="menu">
                                    @Purchase(item,'X',"xbox", "Groove", "Availiable on Groove Music")
                                    @Purchase(item, 'I', "itunes", "ITunes", "Availiable on ITunes")
                                    @Purchase(item, 'A', "amazon", "Amazon", "Availiable at Amazon")
                                    @Purchase(item, 'S', "spotify", "Spotify", "Availiable on Spotify")
                                    <li><a href="https://www.music4dance.net/blog/music4dance-help/playing-or-purchasing-songs/"><span class="glyphicon glyphicon-question-sign" style="margin-left: .25em;margin-right: .25em"></span> Help</a></li>
                                </ul>
                            </div>
                        }
                    }
                </td>
                @if (isAdmin)
                    {
                        var id = "Selected-" + item.SongId;
                        if (canSort)
                        {
                            <td><input name="selectedSongs" id="@id" type="checkbox" value="@item.SongId" /></td>
                            }
                        <td><a href="/song/edit?id=@item.SongId&filter=@filter" role="button" class="btn btn-link btn-sm"><span class="glyphicon glyphicon-pencil"></span></a></td>
                    }

                    <td>
                        @Html.ActionLink(item.Title, "details", "song", new { id = item.SongId, filter }, null)
                        @if (tempoString != null)
                    {
                            <small class="hidden-sm hidden-md hidden-lg">(@Html.Raw(tempoString) BPM)</small>
                        }
                        <span class="visible-xs"> - @Artist(item)</span>
                    </td>

                    @if (!hideArtist)
                    {
                        <td class="hidden-xs">@Artist(item)</td>
                    }

                    @if (albumName == null)
                    {
                        @*<td class="hidden-xs">
                            @if (!string.IsNullOrWhiteSpace(item.AlbumName))
                            {
                                @Html.ActionLink(item.AlbumName, "album", "song", new { title = item.AlbumName }, null)
                            }
                        </td>*@
                    }
                    else
                    {
                        <td class="hidden-xs">
                            @{
                                var track = sd.TrackFromAlbum(albumName);
                                if (track > 0)
                                {
                                    @track.ToString()
                                }
                            }
                        </td>
                    }
                    <td class="hidden-xs">
                        @if (tempoString != null)
                        {
                            @Html.Raw(tempoString)
                        }
                    </td>
                    @if (showLength)
                    {
                        <td class="hidden-xs">
                            @if (item.Length != null)
                            {
                                @((new SongDuration(item.Length.Value)).ToString());
                            }
                        </td>
                    }
                    @if (!hideDances)
                    {
                        <td>
                            @if (scaledDances != null)
                            {
                                const string bstring = "<br />";
                                foreach (var ditem in scaledDances)
                                {
                                    // TODO: Dance name pulled from the danceMap doesn't require a db lookup - is there a way
                                    //  to make the more intuitive ditem.Dance.Name work without a lookup???
                                    var badge = SongCounts.GetRatingBadge(danceMap, ditem.DanceId, ditem.Weight);
                                    var name = danceMap[ditem.DanceId].DanceName;
                                    var label = name;
                                    var tags = string.Empty;
                                    if (!string.IsNullOrWhiteSpace(ditem.TagSummary.Summary))
                                    {
                                        label = label + " <span class='glyphicon glyphicon-asterisk' aria-hidden='true'></span>";
                                        tags += bstring;
                                        foreach (var dtitem in ditem.TagSummary.Tags)
                                        {
                                            tags += TagHelpers.TagButton(dtitem, filter); //"<span class=\"label label-" + dtitem.TagClass.ToLower() + "\">" + dtitem.TagValue + "</span> ";
                                        }
                                    }
                                    var danceQuery = filter.DanceQuery;
                                    var isExclusive = danceQuery.IsExclusive || !danceQuery.Dances.Any();
                                    var hasDance = danceQuery.HasDance(ditem.DanceId);

                                    var content = MvcHtmlString.Create(
                                        Html.ActionLink(name + " dance page...", name, "dances") +
                                        (!filter.IsEmpty && isExclusive && !hasDance ? bstring + Html.ActionLink("Filter list to songs tagged as " + name + "...", "search", "song", new { dances = danceQuery.AddDance(ditem.DanceId).Query, filter }, null) : string.Empty) +
                                        (!filter.IsEmpty && !isExclusive && !hasDance ? bstring + Html.ActionLink("Expand list to included songs tagged as " + name + "...", "search", "song", new { dances = danceQuery.AddDance(ditem.DanceId).Query, filter }, null) : string.Empty) +
                                        bstring + Html.ActionLink("List all " + name + " songs...", "search", "song", new { dances = ditem.DanceId }, null) +
                                        bstring + "<a href=\"https://www.music4dance.net/blog/tag-filtering\">Help</a>" +
                                        tags );

                                    <a href='#!' class='rating @badge label label-music' role='button'
                                       data-container='body' data-toggle='popover' data-placement='left' data-title='@Html.ActionLink(name, name, "dances")'
                                       data-content='@content'>@Html.Raw(label)</a>
                                }
                            }
                            <span class="visible-xs">@Tags(item, filter)</span>
                        </td>
                    }
                    <td class="@(hideDances ? string.Empty : "hidden-xs")">@Tags(item,filter)</td>

                    @if (isAdmin)
                    {
                        var play = item.Sample != null ? (item.Sample != "." ? "P" : "p") : string.Empty;
                        var echo = item.Danceability != null ? (item.Danceability != float.NaN ? "E" : "e") : string.Empty;
                        <td>@(item.Purchase + play + echo)</td>
                    }

                    @if (showDate)
                    {
                        @TimeHelper(item,songOrder)
                    }

                </tr>
            }
        }
    </tbody>
</table>
